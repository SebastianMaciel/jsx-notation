<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="JSXN compresses React JSX/TSX, HTML, and SVG files by ~40% for AI assistants. An MCP server for Claude Code, Cursor, Windsurf, VS Code, Zed, and more.">
<meta name="theme-color" content="#0a0a0a">
<meta property="og:type" content="website">
<meta property="og:title" content="JSXN — Compress JSX, HTML & SVG for AI">
<meta property="og:description" content="An MCP server that compresses React components, HTML, and SVG by ~40% so your AI assistant reads more code in less tokens.">
<meta property="og:url" content="https://sebastianmaciel.github.io/jsx-notation/">
<meta property="og:image" content="https://sebastianmaciel.github.io/jsx-notation/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="JSXN — Compress JSX, HTML & SVG for AI">
<meta name="twitter:description" content="An MCP server that compresses React components, HTML, and SVG by ~40% so your AI assistant reads more code in less tokens.">
<link rel="canonical" href="https://sebastianmaciel.github.io/jsx-notation/">
<title>JSXN — Compress JSX, HTML &amp; SVG for AI</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M10,4 L2,16 L10,28' stroke='%23888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M22,4 L30,16 L22,28' stroke='%23888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M12,16 L20,16' stroke='%234ade80' stroke-width='2.5' stroke-linecap='round'/%3E%3Cpath d='M12,16 L14.5,13.5 M12,16 L14.5,18.5' stroke='%234ade80' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M20,16 L17.5,13.5 M20,16 L17.5,18.5' stroke='%234ade80' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #0a0a0a;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px;
  }

  .hero { text-align: center; margin-bottom: 40px; }
  .hero .logo { margin-bottom: 16px; }
  .hero h1 { font-size: 48px; font-weight: 700; color: #fff; letter-spacing: -0.03em; margin-bottom: 12px; }
  .hero p { font-size: 17px; color: #888; line-height: 1.5; max-width: 540px; margin: 0 auto; }
  .hero .accent { color: #4ade80; font-weight: 500; }
  .hero .hero-sub { font-size: 14px; color: #555; margin-top: 12px; }

  .card {
    width: 100%;
    max-width: 720px;
    border: 1px solid #1e1e1e;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  }

  .card-titlebar {
    background: #1a1a1a;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid #1e1e1e;
  }

  .dot { width: 12px; height: 12px; border-radius: 50%; }
  .dot-red { background: #ff5f57; }
  .dot-yellow { background: #febc2e; }
  .dot-green { background: #28c840; }
  .card-filename {
    margin-left: 8px;
    font-size: 13px;
    color: #666;
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
  }

  .card-body {
    background: #0f0f0f;
    padding: 16px 0;
    transition: opacity 0.3s ease;
  }

  .line {
    padding: 0 20px 0 28px;
    border-left: 3px solid transparent;
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre;
    color: #d4d4d4;
    min-height: 1.6em;
    transition: border-left-color 0.2s, background-color 0.2s, max-height 0.3s ease, opacity 0.3s ease, min-height 0.3s ease, padding-top 0.3s ease, padding-bottom 0.3s ease;
    overflow: hidden;
  }
  .line.hl {
    border-left-color: #4ade80;
    background: rgba(74, 222, 128, 0.05);
  }
  .line.collapsing {
    max-height: 0 !important;
    min-height: 0 !important;
    opacity: 0;
    padding-top: 0;
    padding-bottom: 0;
  }
  .line.inserting {
    max-height: 0;
    min-height: 0;
    opacity: 0;
  }

  .token-counter {
    text-align: center;
    min-height: 56px;
  }
  .token-counter .tokens { font-size: 36px; font-weight: 700; font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }
  .token-counter .tok-before { color: #555; }
  .token-counter .tok-arrow { color: #333; margin: 0 12px; font-weight: 400; }
  .token-counter .tok-after { color: #d4d4d4; transition: color 0.3s; }
  .token-counter .tok-after.shrinking { color: #4ade80; }
  .token-counter .tok-unit { color: #555; font-size: 18px; font-weight: 500; margin-left: 6px; }
  .token-counter .savings { font-size: 17px; color: #4ade80; margin-top: 6px; font-weight: 600; min-height: 24px; }

  .token-counter-section {
    width: 100%;
    max-width: 720px;
    margin-top: 32px;
  }

  /* JSXN syntax */
  .jsxn-header { color: #c586c0; }
  .jsxn-alias-name { color: #9cdcfe; }
  .jsxn-alias-val { color: #ce9178; }
  .jsxn-tag { color: #4ec9b0; }
  .jsxn-class { color: #dcdcaa; }
  .jsxn-id { color: #d7ba7d; }
  .jsxn-string { color: #ce9178; }
  .jsxn-expr { color: #9cdcfe; }
  .jsxn-prop-brace { color: #d4d4d4; }
  .jsxn-prop-key { color: #9cdcfe; }
  .jsxn-prop-val { color: #d4d4d4; }
  .jsxn-cond { color: #c586c0; }
  .jsxn-map { color: #c586c0; }
  .jsxn-chevron { color: #666; }
  .jsxn-pipe { color: #666; }
  .jsxn-fragment { color: #c586c0; }
  .jsxn-spread { color: #569cd6; }

  /* JSX syntax */
  .jsx-kw { color: #c586c0; }
  .jsx-str { color: #ce9178; }
  .jsx-tag { color: #4ec9b0; }
  .jsx-attr { color: #9cdcfe; }
  .jsx-num { color: #b5cea8; }

  .content {
    width: 100%;
    max-width: 720px;
    margin: 0 auto;
  }

  .section { margin-top: 80px; }
  .section h2 {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
  }
  .section .subtext {
    font-size: 15px;
    color: #666;
    margin-bottom: 24px;
  }

  .transform-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .transform-card {
    background: #0f0f0f;
    border: 1px solid #1e1e1e;
    border-radius: 8px;
    padding: 16px;
  }
  .transform-card .label {
    font-size: 11px;
    text-transform: uppercase;
    color: #555;
    letter-spacing: 0.04em;
    margin-bottom: 10px;
  }
  .transform-card .before {
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
    font-size: 12px;
    color: #666;
    text-decoration: line-through;
    text-decoration-color: #333;
    line-height: 1.6;
    white-space: pre;
    overflow-x: auto;
  }
  .transform-card .after {
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
    font-size: 12px;
    line-height: 1.6;
    margin-top: 6px;
    white-space: pre;
    overflow-x: auto;
  }
  .transform-card .after .dim {
    color: #555;
    font-style: italic;
  }


  .install-block {
    background: #0f0f0f;
    border: 1px solid #1e1e1e;
    border-radius: 8px;
    padding: 16px 20px;
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
    font-size: 13px;
    color: #4ade80;
    overflow-x: auto;
    white-space: pre;
  }
  .install-group { margin-bottom: 20px; }
  .install-group hr,
  .section hr {
    border: none;
    border-top: 1px solid #1e1e1e;
    margin: 24px 0;
  }
  .install-note {
    font-size: 13px;
    color: #555;
    line-height: 1.5;
    margin-bottom: 20px;
    padding: 12px 16px;
    border-left: 2px solid #2a2a2a;
  }
  .install-note code {
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
    font-size: 12px;
    color: #666;
  }
  .install-label {
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
  }
  .install-label code {
    font-family: "SF Mono", "Fira Code", "JetBrains Mono", Consolas, monospace;
    font-size: 12px;
    color: #555;
  }
  .install-wrap {
    position: relative;
  }
  .install-wrap .copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 6px;
    color: #666;
    font-size: 12px;
    padding: 4px 10px;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  .install-wrap .copy-btn:hover {
    color: #ccc;
    border-color: #444;
  }
  .install-wrap .copy-btn.copied {
    color: #4ade80;
    border-color: #4ade80;
  }

  .oneclick-row {
    display: flex;
    gap: 12px;
    margin-bottom: 28px;
    flex-wrap: wrap;
  }
  .oneclick-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 8px;
    border: 1px solid #2a2a2a;
    background: #141414;
    color: #ccc;
    font-size: 14px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    text-decoration: none;
    transition: border-color 0.2s, color 0.2s;
  }
  .oneclick-btn:hover {
    border-color: #4ade80;
    color: #fff;
  }
  .oneclick-btn svg { flex-shrink: 0; }

  .bottom-links {
    margin-top: 80px;
    display: flex;
    gap: 32px;
    justify-content: center;
  }
  .bottom-links a {
    color: #888;
    font-size: 15px;
    text-decoration: none;
    transition: color 0.2s;
  }
  .bottom-links a:hover { color: #fff; }

  footer {
    margin-top: 80px;
    padding-bottom: 40px;
    text-align: center;
    font-size: 13px;
    color: #555;
  }
  footer a {
    color: #666;
    text-decoration: none;
    transition: color 0.2s;
  }
  footer a:hover { color: #4ade80; }

  @media (max-width: 768px) {
    body { padding: 24px 16px; }
    .hero h1 { font-size: 36px; }
    .hero p { font-size: 15px; }
    .card { max-width: 100%; }
    .line { font-size: 12px; padding: 0 16px 0 24px; }
    .transform-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 480px) {
    .hero h1 { font-size: 28px; }
    .line { font-size: 11px; padding: 0 12px 0 20px; }
  }

  .skip-link {
    position: absolute;
    top: -100%;
    left: 16px;
    background: #4ade80;
    color: #0a0a0a;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    z-index: 100;
  }
  .skip-link:focus { top: 16px; }
</style>
</head>
<body>

<a href="#main" class="skip-link">Skip to content</a>

<header class="hero" id="hero">
  <svg class="logo" width="80" height="44" viewBox="0 0 80 44" fill="none" aria-hidden="true">
    <path d="M24,6 L6,22 L24,38" stroke="#888" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M56,6 L74,22 L56,38" stroke="#888" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M30,22 L50,22" stroke="#4ade80" stroke-width="3" stroke-linecap="round"/>
    <path d="M30,22 L35,17 M30,22 L35,27" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M50,22 L45,17 M50,22 L45,27" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <h1>JSXN</h1>
  <p>Your React components eat context window for breakfast.<br>
  JSXN compresses them so your AI reads <span class="accent">~40% more code</span>.</p>
  <p class="hero-sub">An MCP server for Claude Code, Cursor, Windsurf, VS Code, Zed, and more.</p>
</header>

<main id="main">

<figure class="card" id="demo" aria-label="Live compression demo">
  <div class="card-titlebar">
    <div class="dot dot-red" aria-hidden="true"></div>
    <div class="dot dot-yellow" aria-hidden="true"></div>
    <div class="dot dot-green" aria-hidden="true"></div>
    <span class="card-filename">TaskList.tsx</span>
  </div>
  <div class="card-body" id="code" role="img" aria-label="Animated code compression from JSX to JSXN notation"></div>
</figure>

<div class="token-counter-section" aria-live="polite">
  <div class="token-counter" id="counter">
    <div class="tokens">
      <span class="tok-before">195</span>
      <span class="tok-arrow" aria-hidden="true">&rarr;</span>
      <span class="tok-after" id="tok-cur">195</span>
      <span class="tok-unit">tokens</span>
    </div>
    <div class="savings" id="savings"></div>
  </div>
</div>

<div class="content">

  <section class="section" id="transforms">
    <h2>Each line, compressed</h2>
    <p class="subtext">10 deterministic transforms, top to bottom. Fully reversible.</p>
    <div class="transform-grid" id="transform-grid" role="list" aria-label="Compression transforms"></div>
  </section>

  <section class="section" id="get-started">
    <h2>Get started</h2>
    <p class="subtext" style="margin-bottom: 12px;">One-click install</p>
    <div class="oneclick-row">
      <a class="oneclick-btn" href="https://cursor.com/en/install-mcp?name=jsx-notation&config=eyJjb21tYW5kIjoibnB4IiwiYXJncyI6WyJqc3gtbm90YXRpb24tbWNwIl19" target="_blank" rel="noopener noreferrer">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><path d="M1 1L8 4L15 1V12L8 15L1 12V1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 4V15" stroke="currentColor" stroke-width="1.5"/></svg>
        Install in Cursor
      </a>
      <a class="oneclick-btn" href="https://vscode.dev/redirect/mcp/install?name=jsx-notation&config=%7B%22command%22%3A%22npx%22%2C%22args%22%3A%5B%22jsx-notation-mcp%22%5D%7D" target="_blank" rel="noopener noreferrer">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><path d="M11 1L4.5 7L2 5V11L4.5 9L11 15L14 13.5V2.5L11 1Z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/></svg>
        Install in VS Code
      </a>
    </div>
    <div class="install-group">
      <div class="install-label">Claude Code</div>
      <div class="install-wrap">
        <div class="install-block">claude mcp add jsx-notation -- npx jsx-notation-mcp</div>
        <button class="copy-btn" onclick="copyBlock(this)" aria-label="Copy to clipboard">Copy</button>
      </div>
      <hr>
    </div>
    <div class="install-group">
      <div class="install-label">VS Code &mdash; <code>.vscode/mcp.json</code></div>
      <div class="install-wrap">
        <div class="install-block">{
  "servers": {
    "jsx-notation": {
      "command": "npx",
      "args": ["jsx-notation-mcp"]
    }
  }
}</div>
        <button class="copy-btn" onclick="copyBlock(this)" aria-label="Copy to clipboard">Copy</button>
      </div>
      <hr>
    </div>
    <div class="install-group">
      <div class="install-label">Cursor &mdash; <code>~/.cursor/mcp.json</code></div>
      <div class="install-wrap">
        <div class="install-block">{
  "mcpServers": {
    "jsx-notation": {
      "command": "npx",
      "args": ["jsx-notation-mcp"]
    }
  }
}</div>
        <button class="copy-btn" onclick="copyBlock(this)" aria-label="Copy to clipboard">Copy</button>
      </div>
      <hr>
    </div>
    <div class="install-group">
      <div class="install-label">Windsurf &mdash; <code>~/.codeium/windsurf/mcp_config.json</code></div>
      <div class="install-wrap">
        <div class="install-block">{
  "mcpServers": {
    "jsx-notation": {
      "command": "npx",
      "args": ["jsx-notation-mcp"]
    }
  }
}</div>
        <button class="copy-btn" onclick="copyBlock(this)" aria-label="Copy to clipboard">Copy</button>
      </div>
    </div>
    <div class="install-note">
      <strong>Cline</strong>, <strong>Continue</strong>, <strong>Amazon Q</strong>, and <strong>JetBrains</strong> IDEs also use the same <code>mcpServers</code> format. Paste the JSON above into your MCP settings.
    </div>
      <hr>
    </div>
    <div class="install-group">
      <div class="install-label">Zed &mdash; <code>~/.config/zed/settings.json</code></div>
      <div class="install-wrap">
        <div class="install-block">{
  "context_servers": {
    "jsx-notation": {
      "command": "npx",
      "args": ["jsx-notation-mcp"]
    }
  }
}</div>
        <button class="copy-btn" onclick="copyBlock(this)" aria-label="Copy to clipboard">Copy</button>
      </div>
    </div>
  </section>

  <nav class="bottom-links" id="links" aria-label="Quick links">
    <a href="editor.html">Try the encoder &rarr;</a>
    <a href="editor.html#decode">Try the decoder &rarr;</a>
    <a href="https://github.com/SebastianMaciel/jsx-notation" target="_blank" rel="noopener noreferrer">GitHub &rarr;</a>
  </nav>

</div>

</main>

<footer id="footer">
  Made by <a href="https://github.com/SebastianMaciel" target="_blank" rel="noopener noreferrer">Sebasti&aacute;n Maciel</a> &middot; MIT License
</footer>

<script>
// ── Initial JSX lines (IDs 0-29) ──────────────────────────
const INIT = [
  'import { useState, useRef } from "react";',
  'import { Button } from "./components/Button";',
  'import type { Task } from "./types";',
  '',
  'export default function TaskList({ title }: { title: string }) {',
  '  const [tasks, setTasks] = useState<Task[]>([]);',
  '  const [filter, setFilter] = useState("all");',
  '  const inputRef = useRef<HTMLInputElement>(null);',
  '',
  '  const visible = tasks.filter(t => filter === "all" || t.status === filter);',
  '',
  '  return (',
  '    <div className="task-container">',
  '      <h2 className="task-title">{title}</h2>',
  '      <input ref={inputRef} className="task-input" placeholder="Add task..." />',
  '      <div className="task-actions">',
  '        <Button onClick={() => addTask()} variant="primary">Add</Button>',
  '        <Button onClick={() => setTasks([])} variant="ghost">Clear</Button>',
  '      </div>',
  '      <ul className="task-list">',
  '        {visible.map(task => (',
  '          <li key={task.id} className="task-item">',
  '            <span>{task.text}</span>',
  '            {task.done && <span className="task-done">Done</span>}',
  '          </li>',
  '        ))}',
  '      </ul>',
  '    </div>',
  '  );',
  '}',
];

// ── Mutation queue ─────────────────────────────────────────
// Each mutation: { delay, changes:[[id,newText]], removes:[id], inserts:[[afterId,text]] }
const M = [
  // Imports                                          tokens after
  { d:2500, c:[[0,'@I react: useState, useRef']],              t:188 },
  { d:220,  c:[[1,'@I ./components/Button: Button']],          t:183 },
  { d:220,  c:[[2,'@T ./types: Task']],                        t:179 },
  // Signature
  { d:700,  c:[[4,'export default TaskList({ title })']],      t:172 },
  // Hooks
  { d:500,  c:[[5,'  @state tasks = []']],                     t:167 },
  { d:220,  c:[[6,'  @state filter = "all"']],                 t:163 },
  { d:220,  c:[[7,'  @ref inputRef = null']],                  t:160 },
  // Logic
  { d:500,  c:[[9,'  visible = tasks.filter(t => filter === "all" || t.status === filter);']], t:159 },
  // Separator: empty→---, remove "return ("
  { d:500,  c:[[10,'  ---']], r:[11],                          t:155 },
  // JSX body tags
  { d:350,  c:[[12,'  div.task-container']],                   t:151 },
  { d:250,  c:[[13,'    h2.task-title (title)']],              t:146 },
  { d:250,  c:[[14,'    input {ref:inputRef, placeholder:"Add task..."}.task-input']], t:143 },
  { d:250,  c:[[15,'    div.task-actions']],                   t:140 },
  // Buttons → B aliases + @C header + remove </div>
  { d:250,  i:[[2,'@C Button=B']], c:[[16,'      B {onClick:() => addTask(), variant:"primary"} "Add"'],[17,'      B {onClick:() => setTasks([]), variant:"ghost"} "Clear"']], r:[18], t:132 },
  // List section
  { d:250,  c:[[19,'    ul.task-list']],                       t:129 },
  { d:250,  c:[[20,'      *visible > li {key:task.id}.task-item']], r:[21], t:125 },
  { d:220,  c:[[22,'        span (task.text)']],               t:121 },
  { d:220,  c:[[23,'        ?task.done > span.task-done "Done"']], r:[24,25,26,27,28,29], t:116 },
];

// ── State ──────────────────────────────────────────────────
let lines = [];      // [{id, text}]
let elMap = {};      // id → DOM element
let nextId = 30;
let curTokens = 195;
const codeEl = document.getElementById('code');
const tokCur = document.getElementById('tok-cur');
const savingsEl = document.getElementById('savings');

// ── JSXN highlighter (from index.html) ────────────────────
function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function hlLine(line) {
  if (/^\s*@[CPS]\s/.test(line)) {
    return line.replace(/^(\s*@[CPS])\s(.*)$/, (_,pre,rest) => {
      const pairs = rest.replace(/([A-Za-z][\w.\-]*)=([A-Za-z]\w*)/g,
        (__,n,a) => `<span class="jsxn-alias-name">${esc(n)}</span>=<span class="jsxn-alias-val">${esc(a)}</span>`);
      return `<span class="jsxn-header">${esc(pre)}</span> ${pairs}`;
    });
  }
  if (/^\s*@[IT]\s/.test(line)) {
    return line.replace(/^(\s*@[IT])\s(.*)$/, (_,pre,rest) =>
      `<span class="jsxn-header">${esc(pre)}</span> ${esc(rest)}`);
  }
  if (/^\s*@(state|ref)\s/.test(line)) {
    return line.replace(/^(\s*)(@(?:state|ref))\s(.*)$/, (_,ws,kw,rest) =>
      `${ws}<span class="jsxn-header">${esc(kw)}</span> ${esc(rest)}`);
  }
  if (/^\s*---\s*$/.test(line)) {
    const ws = line.match(/^(\s*)/)[1];
    return `${ws}<span class="jsxn-header">---</span>`;
  }
  if (!line.trim()) return '';
  const indent = line.match(/^(\s*)/)[1];
  const content = line.slice(indent.length);
  if (content === '_') return `${indent}<span class="jsxn-fragment">_</span>`;

  if (content.startsWith('?')) {
    const m = content.match(/^\?(.+?)\s*>\s*(.*)$/);
    if (m) {
      const after = m[2], pi = ftlp(after);
      if (pi >= 0) {
        return `${indent}<span class="jsxn-cond">?</span><span class="jsxn-expr">${esc(m[1])}</span> <span class="jsxn-chevron">&gt;</span> ${hlTag(after.slice(0,pi).trim())} <span class="jsxn-pipe">|</span> ${hlTag(after.slice(pi+1).trim())}`;
      }
      return `${indent}<span class="jsxn-cond">?</span><span class="jsxn-expr">${esc(m[1])}</span> <span class="jsxn-chevron">&gt;</span> ${hlTag(after)}`;
    }
  }
  if (content.startsWith('*')) {
    const m = content.match(/^\*(.+?)\s*>\s*(.*)$/);
    if (m) return `${indent}<span class="jsxn-map">*</span><span class="jsxn-expr">${esc(m[1])}</span> <span class="jsxn-chevron">&gt;</span> ${hlTag(m[2])}`;
  }
  if (/^".*"$/.test(content)) return `${indent}<span class="jsxn-string">${esc(content)}</span>`;
  if (content.startsWith('(') && content.endsWith(')')) return `${indent}<span class="jsxn-expr">${esc(content)}</span>`;
  return indent + hlTag(content);
}

function hlTag(s) {
  let rest = s, result = '';
  const se = rest.search(/[\s{]/);
  const sp = se===-1 ? rest : rest.slice(0,se);
  rest = se===-1 ? '' : rest.slice(se);
  result += hlSel(sp);
  if (!rest) return result;
  const bi = rest.indexOf('{');
  if (bi >= 0) {
    result += esc(rest.slice(0,bi));
    const be = fmb(rest,bi);
    if (be >= 0) { result += hlProps(rest.slice(bi,be+1)); rest = rest.slice(be+1); }
    else { result += esc(rest.slice(bi)); rest = ''; }
  }
  if (rest.trim()) {
    const tr = rest.trimStart(), sp2 = rest.slice(0,rest.length-tr.length);
    if (tr.startsWith('"')) result += `${esc(sp2)}<span class="jsxn-string">${esc(tr)}</span>`;
    else if (tr.startsWith('(')) result += `${esc(sp2)}<span class="jsxn-expr">${esc(tr)}</span>`;
    else result += esc(rest);
  }
  return result;
}

function hlSel(s) {
  return s.split(/(?=[#.])/).map(t =>
    t.startsWith('#') ? `<span class="jsxn-id">${esc(t)}</span>` :
    t.startsWith('.') ? `<span class="jsxn-class">${esc(t)}</span>` :
    `<span class="jsxn-tag">${esc(t)}</span>`
  ).join('');
}

function hlProps(block) {
  const inner = block.slice(1,-1);
  let r = '<span class="jsxn-prop-brace">{</span>';
  const parts = stl(inner,',');
  for (let i=0;i<parts.length;i++) {
    if (i>0) r += '<span class="jsxn-prop-brace">, </span>';
    const p = parts[i].trim();
    if (p.startsWith('...')) { r += `<span class="jsxn-spread">${esc(p)}</span>`; }
    else {
      const ci = p.indexOf(':');
      if (ci>=0) r += `<span class="jsxn-prop-key">${esc(p.slice(0,ci))}</span>:<span class="jsxn-prop-val">${esc(p.slice(ci+1))}</span>`;
      else r += `<span class="jsxn-prop-key">${esc(p)}</span>`;
    }
  }
  return r + '<span class="jsxn-prop-brace">}</span>';
}

function fmb(s,start) {
  let d=0;
  for (let i=start;i<s.length;i++) { if(s[i]==='{')d++; else if(s[i]==='}'){d--;if(d===0)return i;} }
  return -1;
}
function stl(s,sep) {
  const p=[]; let d=0,c='';
  for (let i=0;i<s.length;i++) {
    const ch=s[i];
    if(ch==='('||ch==='{'||ch==='[')d++; else if(ch===')'||ch==='}'||ch===']')d--;
    if(ch===sep&&d===0){p.push(c);c='';} else c+=ch;
  }
  if(c)p.push(c); return p;
}
function ftlp(s) {
  let d=0;
  for(let i=0;i<s.length;i++){const ch=s[i];if(ch==='('||ch==='{'||ch==='[')d++;else if(ch===')'||ch==='}'||ch===']')d--;if(ch==='|'&&d===0)return i;}
  return -1;
}

// ── JSX highlighter (simple regex) ────────────────────────
function hlJSX(line) {
  if (!line.trim()) return '';
  let r = esc(line);
  // Strings
  r = r.replace(/"[^"]*"/g, '<span class="jsx-str">$&</span>');
  // Tags
  r = r.replace(/(&lt;\/?)([\w.]+)/g, (_,b,t) => `${b}<span class="jsx-tag">${t}</span>`);
  r = r.replace(/(\/?&gt;)/g, '<span class="jsx-tag">$1</span>');
  // Keywords
  r = r.replace(/\b(import|from|export|default|function|const|let|var|return|type|interface)\b/g, '<span class="jsx-kw">$1</span>');
  // Attributes
  r = r.replace(/\b([a-zA-Z][\w]*)(?==(?:&quot;|<span|{|\())/g, '<span class="jsx-attr">$1</span>');
  return r;
}

// ── Mixed highlighter (auto-detect per line) ──────────────
function highlight(text) {
  const t = text.trimStart();
  if (/^@[ITCPS]\s/.test(t) || /^@(state|ref)\s/.test(t) || /^---\s*$/.test(t) ||
      /^\?/.test(t) || /^\*\w/.test(t)) return hlLine(text);
  if (/^[a-z][\w]*[.#]/.test(t) && !t.startsWith('<')) return hlLine(text);
  if (/^(div|span|ul|li|h[1-6]|input|button|form|section|nav|main|header|footer|p|a|img)\b/.test(t) && !t.startsWith('<')) return hlLine(text);
  if (/^[A-Z]\s/.test(t) && !t.startsWith('<')) return hlLine(text);
  return hlJSX(text);
}

// ── DOM helpers ───────────────────────────────────────────
function createEl(line) {
  const el = document.createElement('div');
  el.className = 'line';
  el.innerHTML = highlight(line.text) || '&nbsp;';
  return el;
}

function renderAll() {
  codeEl.innerHTML = '';
  elMap = {};
  for (const ln of lines) {
    const el = createEl(ln);
    codeEl.appendChild(el);
    elMap[ln.id] = el;
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ── Apply one mutation ────────────────────────────────────
async function apply(mut) {
  const touched = new Set();

  // 1. Highlight lines that will change
  if (mut.c) for (const [id] of mut.c) { elMap[id]?.classList.add('hl'); touched.add(id); }
  if (mut.r) for (const id of mut.r)   { elMap[id]?.classList.add('hl'); touched.add(id); }
  await sleep(250);

  // 2. Apply content changes
  if (mut.c) {
    for (const [id, newText] of mut.c) {
      const ln = lines.find(l => l.id === id);
      if (ln) { ln.text = newText; elMap[id].innerHTML = highlight(newText) || '&nbsp;'; }
    }
  }

  // 3. Inserts
  if (mut.i) {
    for (const [afterId, text] of mut.i) {
      const nid = nextId++;
      const newLn = { id: nid, text };
      const ai = lines.findIndex(l => l.id === afterId);
      lines.splice(ai + 1, 0, newLn);
      const el = createEl(newLn);
      el.classList.add('inserting');
      el.classList.add('hl');
      elMap[afterId].after(el);
      elMap[nid] = el;
      // Trigger reflow then expand
      el.offsetHeight;
      el.classList.remove('inserting');
      touched.add(nid);
    }
  }

  // 4. Removals (collapse)
  if (mut.r) {
    for (const id of mut.r) {
      const el = elMap[id];
      if (el) {
        el.classList.add('collapsing');
        el.classList.remove('hl');
        lines = lines.filter(l => l.id !== id);
        setTimeout(() => { el.remove(); delete elMap[id]; }, 300);
      }
    }
  }

  // 5. Hold highlight briefly
  await sleep(350);

  // 6. Remove highlights
  for (const id of touched) {
    if (elMap[id]) elMap[id].classList.remove('hl');
  }
}

// ── Token counter animation ───────────────────────────────
function animTokens(to) {
  const from = curTokens;
  if (from === to) return;
  const start = performance.now();
  const dur = 400;
  tokCur.classList.add('shrinking');
  (function tick(now) {
    const p = Math.min((now - start) / dur, 1);
    const eased = 1 - Math.pow(1 - p, 3);
    const val = Math.round(from + (to - from) * eased);
    tokCur.textContent = val;
    const pct = Math.round((1 - val / 195) * 100);
    savingsEl.textContent = pct > 0 ? `~${pct}% smaller` : '';
    if (p < 1) requestAnimationFrame(tick);
    else curTokens = to;
  })(performance.now());
}

function resetTokens() {
  curTokens = 195;
  tokCur.textContent = '195';
  tokCur.classList.remove('shrinking');
  savingsEl.textContent = '';
}

// ── Main loop ─────────────────────────────────────────────
async function run() {
  while (true) {
    // Reset
    lines = INIT.map((t, i) => ({ id: i, text: t }));
    nextId = 30;
    renderAll();
    codeEl.style.minHeight = codeEl.offsetHeight + 'px';
    resetTokens();

    // Run mutations
    for (const mut of M) {
      await sleep(mut.d);
      await apply(mut);
      if (mut.t != null) animTokens(mut.t);
    }

    // Hold final state
    await sleep(5000);

    // Fade out before reset
    codeEl.style.opacity = '0';
    await sleep(300);
    codeEl.style.opacity = '1';
  }
}

// ── Copy button ───────────────────────────────────────────
function copyBlock(btn) {
  const text = btn.parentElement.querySelector('.install-block').textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
  });
}

// ── Transform reference grid ──────────────────────────────
(function buildTransformGrid() {
  const transforms = [
    { label: 'Imports', before: 'import { useState } from "react"', after: '@I react: useState' },
    { label: 'Type imports', before: 'import type { Task } from "./types"', after: '@T ./types: Task' },
    { label: 'State', before: 'const [x, setX] = useState(0)', after: '@state x = 0' },
    { label: 'Refs', before: 'const ref = useRef(null)', after: '@ref ref = null' },
    { label: 'JSX boundary', before: 'return (', after: '---' },
    { label: 'Selectors', before: '<div className="card">', after: 'div.card' },
    { label: 'Closing tags', before: '</div></ul></li>', after: null },
    { label: 'Conditionals', before: '{ok && <Badge/>}', after: '?ok > Badge' },
    { label: 'Iteration', before: '{items.map(i => <X/>)}', after: '*items > X' },
    { label: 'Aliases', before: '<Button/> used 5\u00d7', after: '@C Button=B' },
  ];
  const grid = document.getElementById('transform-grid');
  for (const t of transforms) {
    const card = document.createElement('div');
    card.className = 'transform-card';
    card.setAttribute('role', 'listitem');
    const afterHTML = t.after === null
      ? '<span class="dim">(indentation)</span>'
      : highlight(t.after);
    card.innerHTML =
      '<div class="label">' + esc(t.label) + '</div>' +
      '<div class="before" aria-label="Before: ' + esc(t.before) + '">' + hlJSX(t.before) + '</div>' +
      '<div class="after" aria-label="After: ' + esc(t.after || '(indentation)') + '">' + afterHTML + '</div>';
    grid.appendChild(card);
  }
})();

run();
</script>
</body>
</html>
